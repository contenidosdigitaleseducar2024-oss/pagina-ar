<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindAR — Tiramisu (solo MindAR)</title>
  <style>
    html,body { height:100%; margin:0; background:#111; color:#eee; font-family:system-ui, Arial; }
    #ar-container { width:100%; height:100vh; position:relative; overflow:hidden; }
    .ui { position:absolute; left:16px; top:16px; z-index:20; display:flex; gap:8px; }
    button { padding:8px 12px; border-radius:8px; border:none; background:#0b84ff; color:white; cursor:pointer; }
    .info { position:absolute; left:16px; bottom:16px; z-index:20; background:rgba(0,0,0,0.45); padding:8px 12px; border-radius:8px; }
    .hint { position:absolute; right:16px; top:16px; z-index:20; background:rgba(0,0,0,0.45); padding:8px 12px; border-radius:8px; }
  </style>
</head>
<body>

<!--
  Archivo: MindAR-only-tiramisu.html
  Propósito: Web que usa SOLO MindAR (image tracking) + Three.js para mostrar 'modelos/tiramisu.glb'
  Requisitos:
   - targets.mind (archivo de target generado con MindAR target creator)
   - modelos/tiramisu.glb
   - Servir vía HTTPS o localhost
-->

<div id="ar-container"></div>
<div class="ui">
  <button id="startBtn">Iniciar AR</button>
  <button id="stopBtn" disabled>Detener AR</button>
</div>
<div class="hint">Apunta la cámara a la imagen objetivo</div>
<div class="info">Si tu navegador no soporta cámara/AR verás un mensaje.</div>

<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.150.1/examples/jsm/loaders/GLTFLoader.js';
  import { MindARThree } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js';

  // Elementos UI
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const info = document.querySelector('.info');

  // Crear MindARThree
  const mindarThree = new MindARThree({
    container: document.querySelector('#ar-container'),
    imageTargetSrc: 'targets.mind', // <-- coloca aquí tu archivo .mind
    maxTrack: 1,
    uiScanning: true,
    uiLoading: true
  });

  const { renderer, scene, camera } = mindarThree;

  // Añadir un anchor para la primera imagen objetivo
  const anchor = mindarThree.addAnchor(0);

  // Cargar GLB
  const loader = new GLTFLoader();
  let mixer = null;

  loader.load('modelos/tiramisu.glb', (gltf) => {
    const model = gltf.scene;
    // Ajustes por defecto (puedes modificar según tu modelo)
    model.scale.set(0.7, 0.7, 0.7);
    model.position.set(0, 0, 0);
    model.rotation.set(0, 0, 0);

    // Centrar modelo si es necesario
    const box = new THREE.Box3().setFromObject(model);
    const size = new THREE.Vector3(); box.getSize(size);
    if (size.y > 0) {
      const scaleFactor = 1 / size.y; // normalizar por altura
      model.scale.multiplyScalar(scaleFactor * 0.5);
    }

    anchor.group.add(model);

    // Animaciones (si existen)
    if (gltf.animations && gltf.animations.length) {
      mixer = new THREE.AnimationMixer(model);
      gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
    }

  }, (xhr) => {
    // progreso opcional
    // info.textContent = `Cargando modelo: ${Math.round(xhr.loaded / xhr.total * 100)}%`;
  }, (err) => {
    console.error('Error cargando GLB:', err);
    info.textContent = 'Error cargando el modelo. Revisa la ruta modelos/tiramisu.glb';
  });

  // Loop de render
  const clock = new THREE.Clock();
  renderer.setAnimationLoop(() => {
    const delta = clock.getDelta();
    if (mixer) mixer.update(delta);
    renderer.render(scene, camera);
  });

  // Botones
  startBtn.addEventListener('click', async () => {
    try {
      await mindarThree.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      info.textContent = 'AR activo — apunta a la imagen objetivo.';
    } catch (err) {
      console.error('No se pudo iniciar MindAR:', err);
      info.textContent = 'No se pudo acceder a la cámara o el navegador no lo permite.';
      alert('No se pudo iniciar AR. Asegúrate de usar HTTPS y dar permiso a la cámara.');
    }
  });

  stopBtn.addEventListener('click', async () => {
    await mindarThree.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    info.textContent = 'AR detenido.';
  });

  // Mensaje si el dispositivo no soporta getUserMedia
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    info.textContent = 'Tu navegador no soporta cámara (getUserMedia). Prueba con Chrome o Safari recientes.';
    startBtn.disabled = true;
  }

  // Limpieza
  window.addEventListener('beforeunload', async () => {
    try { await mindarThree.stop(); } catch(e){}
  });

</script>

</body>
</html>
